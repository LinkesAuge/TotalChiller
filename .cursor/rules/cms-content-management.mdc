---
description: CMS content management system conventions for all public pages
globs: app/**/page.tsx, app/**/*-client.tsx, app/components/editable-text.tsx, app/components/cms-markdown.tsx, app/components/cms-markdown-toolbar.tsx, app/components/cms-shared.tsx, app/components/editable-list.tsx, app/components/use-site-content.ts, app/components/markdown-renderers.tsx, app/api/site-content/**, app/api/site-list-items/**, proxy.ts
alwaysApply: false
---

# CMS Content Management System

## Architecture Overview

The CMS uses two Supabase tables:
- **`site_content`** — Text fields (title, body text, etc.) with bilingual DE/EN support.
- **`site_list_items`** — Structured list items with sort_order, badges, icons, and links.

### Components

| Component | Purpose |
|-----------|---------|
| `CmsMarkdown` | Configurable Markdown renderer (`.cms-md` CSS, inherits parent styles) |
| `CmsMarkdownToolbar` | Editing toolbar for CMS markdown textareas |
| `EditableText` | Inline-editable text with bilingual editing, 4 rendering paths |
| `EditableList` | List component with drag-and-drop, badges, icons, inline edit modal |
| `useSiteContent(page)` | Shared hook: loads content + lists, admin check, CRUD helpers |
| `LoadingSkeleton` | Animated skeleton loading state |
| `ErrorBanner` | Error display with optional retry |
| `markdown-renderers.tsx` | Shared embed utilities for CmsMarkdown and ForumMarkdown |

### Key Design Decisions

- **CmsMarkdown instead of ForumMarkdown** — CMS uses its own Markdown renderer with `.cms-md` CSS that inherits parent font-size/line-height/color. ForumMarkdown is only for the forum.
- **No `normalizeContent()`** — Removed entirely. `CmsMarkdown` runs a `sanitizeCmsMarkdown()` function that normalizes Windows line endings and auto-fixes broken emphasis markers (`**word **` → `**word**`, `*word *` → `*word*`).
- **Admin-only permissions** — Both client and server check `is_any_admin` or `profiles.is_admin`. No `getIsContentManager()` in CMS context.
- **Lists in separate table** — `site_list_items` with proper sort_order, icons, badges per item. Not stored as flat key-value pairs.
- **Error handling** — `saveField()` and list operations throw on failure. `EditableText` and `EditableList` show errors inline.

## Page Structure

- Server Component `page.tsx` is a thin wrapper.
- Client Component `*-client.tsx` uses `useSiteContent(pageName)`.
- Fallback content from `next-intl` translation files.

```typescript
const {
  content, lists, canEdit, userId, supabase, locale, isLoaded, error,
  c, cEn, saveField,
  addListItem, updateListItem, removeListItem, reorderListItems,
} = useSiteContent("page");

if (!isLoaded) return <LoadingSkeleton rows={4} />;
if (error) return <ErrorBanner message={error} />;
```

## EditableText — 4 Rendering Paths

1. **`children`** — Renders children inside original HTML tag. No CMS text.
2. **`singleLine`** — Plain text in original tag. Simple DE/EN inputs for editing.
3. **`markdown={true}`** — CmsMarkdown in `<div>`. CmsMarkdownToolbar + preview for editing.
4. **`markdown={false}` (default)** — Plain text with `<br>` in `<div>`. Textarea for editing.

The `markdown` prop is now **explicitly checked** — it is NOT ignored.

Pencil button is always an **absolute hover overlay** — never takes layout space.

## EditableList

- Items from `useSiteContent` hook via `lists["sectionKey"]`.
- Drag-and-drop reordering via native HTML Drag API.
- Inline edit modal for text (DE/EN), badge, link, icon.
- CmsMarkdown rendering for item text.
- Preset icon picker (15 icons).
- Add/remove/edit buttons are hover-only overlays.

## Access Control

- `GET /api/site-content?page=X` — Public (service role client).
- `PATCH /api/site-content` — Admin-only.
- `GET /api/site-list-items?page=X` — Public (service role client).
- `PATCH /api/site-list-items` — Admin-only (create/update/delete/reorder).
- All `/api/` routes bypass the proxy auth redirect by default (they handle their own auth). The CMS API paths are also listed in `isPublicPath()` for historical reasons but this is now redundant.

## CSS

- `.cms-md` — CMS Markdown: inherits font-size/line-height/color from parent.
- `.cms-md p:only-child` — margin: 0 (no extra spacing for single paragraphs).
- `.forum-md` — Forum-specific (0.88rem, own colors). Do NOT use in CMS context.
- Edit buttons use `opacity: 0` → `opacity: 1` on hover with `transition: 0.15s`.

## Naming Conventions

- "Registrieren" / "Register" (not "Jetzt bewerben").
- "Einloggen" / "Sign In" (not "Anmelden").
- "Clan-Neuigkeiten" / "Clan News" (not "Öffentliche Neuigkeiten").

## Adding CMS to a New Page

1. Create `app/{page}/{page}-client.tsx` as "use client" component.
2. Use `useSiteContent("{page}")` — get content, lists, canEdit, helpers.
3. Wrap text in `<EditableText>` with `markdown` for multi-line formatted fields.
4. Use `<EditableList>` for dynamic list sections.
5. Add `<LoadingSkeleton>` for loading and `<ErrorBanner>` for errors.
6. Add seed data to `Documentation/migrations/site_content.sql` and/or `site_list_items.sql`.
7. API routes bypass the proxy auth redirect by default — no need to add new API paths to `isPublicPath()`.
