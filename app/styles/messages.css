/* Messages: layout, conversation list, chat-style bubbles, reply form */
/* ─── Messages ─── */
.messages-layout {
  grid-column: 1 / -1;
  display: grid;
  grid-template-columns: minmax(280px, 420px) 1fr;
  gap: 16px;
  min-height: 500px;
  max-height: calc(100vh - 200px);
}

.messages-list-panel {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  max-height: inherit;
  min-height: 0;
}

.messages-view-tabs {
  display: flex;
  /* Stable min-height prevents layout shift when tab badges appear/disappear */
  min-height: 48px;
  border-bottom: 1px solid var(--color-edge);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}

.messages-view-tabs::-webkit-scrollbar {
  display: none;
}

.messages-view-tab {
  flex: 1 1 0;
  min-width: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  padding: 14px 10px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  background: transparent;
  border: none;
  border-bottom: 2px solid transparent;
  color: var(--color-text-2);
  font: inherit;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition-fast);
}

.messages-view-tab:hover {
  color: var(--color-text);
  background: var(--color-gold-a04);
}

.messages-view-tab.active {
  color: var(--color-gold-2);
  border-bottom-color: var(--color-gold);
}

/* Compact unread-count badge inside view-mode tabs.
   Overrides the heavy global .badge padding/shadow/hover so it
   stays small and doesn't cause layout shifts when it appears. */
.messages-view-tab .messages-tab-badge {
  padding: 1px 7px;
  font-size: 0.68rem;
  line-height: 1.2;
  border-width: 1px;
  box-shadow: none;
  text-transform: none;
  letter-spacing: 0;
  pointer-events: none;
  transform: none;
}

.messages-view-tab .messages-tab-badge:hover {
  transform: none;
  box-shadow: none;
}

.messages-broadcast-info {
  padding: 10px 18px;
  background: rgba(74, 105, 160, 0.1);
  border-bottom: 1px solid rgba(74, 105, 160, 0.2);
  color: var(--color-text-2);
  font-size: 0.82rem;
  text-align: center;
}

.messages-filters {
  padding: 0 18px 12px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.messages-filters .tabs {
  padding: 4px;
}

.messages-conversation-list {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.messages-conversation-item {
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 12px 18px;
  border: none;
  border-left: 3px solid transparent;
  border-bottom: 1px solid var(--color-gold-a12);
  background: transparent;
  text-align: left;
  cursor: pointer;
  color: var(--color-text);
  font: inherit;
  transition: var(--transition-fast);
  width: 100%;
}

.messages-conversation-item:hover,
.messages-conversation-item:focus-visible {
  background: var(--color-gold-a06);
  outline: none;
}

.messages-conversation-item.active {
  background: var(--color-gold-a12);
  border-left: 3px solid var(--color-gold);
}

.messages-conversation-item.unread strong {
  color: var(--color-gold-2);
}

/* Conversation item — email-style 3-row layout */
.messages-conversation-subject-row {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  gap: 8px;
}

/* Leading area: checkbox + subject */
.messages-conversation-leading {
  display: flex;
  align-items: center;
  gap: 8px;
  min-width: 0;
  flex: 1;
}

.messages-conversation-actions {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-shrink: 0;
}

/* ── Checkboxes ── */
input.messages-checkbox[type="checkbox"] {
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  min-width: 16px;
  min-height: 16px;
  max-width: 16px;
  max-height: 16px;
  flex-shrink: 0;
  border: 1.5px solid var(--color-text-muted);
  border-radius: 3px;
  background: transparent;
  cursor: pointer;
  transition: var(--transition-fast);
  position: relative;
}

input.messages-checkbox[type="checkbox"]:checked {
  background: var(--color-gold);
  border-color: var(--color-gold);
}

input.messages-checkbox[type="checkbox"]:checked::after {
  content: "";
  position: absolute;
  left: 4px;
  top: 1px;
  width: 5px;
  height: 9px;
  border: solid var(--color-bg);
  border-width: 0 2px 2px 0;
  transform: rotate(45deg);
}

input.messages-checkbox[type="checkbox"]:hover {
  border-color: var(--color-gold);
}

.messages-conversation-item.checked {
  background: var(--color-gold-a06);
}

/* ── Batch action bar ── */
.messages-batch-bar {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 6px 12px;
  padding: 8px 14px;
  background: var(--color-gold-a06);
  border-bottom: 1px solid var(--color-gold-a18);
}

.messages-batch-select-all {
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
  cursor: pointer;
}

.messages-batch-delete-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border: none;
  border-radius: var(--radius-sm);
  background: rgba(220, 53, 69, 0.15);
  color: var(--color-accent-red);
  font: inherit;
  font-size: 0.78rem;
  font-weight: 600;
  white-space: nowrap;
  cursor: pointer;
  transition: var(--transition-fast);
}

.messages-batch-delete-btn:hover {
  background: rgba(220, 53, 69, 0.25);
}

.messages-batch-cancel-btn {
  margin-left: auto;
  padding: 4px 10px;
  border: none;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--color-text-muted);
  font: inherit;
  font-size: 0.78rem;
  white-space: nowrap;
  cursor: pointer;
  transition: var(--transition-fast);
}

.messages-batch-cancel-btn:hover {
  color: var(--color-text);
  background: var(--color-gold-a06);
}

/* ── Action buttons inside list items — visible on hover ── */
.messages-list-action-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 26px;
  height: 26px;
  padding: 0;
  border: none;
  border-radius: var(--radius-sm);
  background: transparent;
  color: var(--color-text-muted);
  cursor: pointer;
  opacity: 0;
  transition: var(--transition-fast);
}

.messages-conversation-item:hover .messages-list-action-btn,
.messages-conversation-item:focus-within .messages-list-action-btn {
  opacity: 0.6;
}

/* Touch devices: always show action buttons since there is no hover state */
@media (hover: none) {
  .messages-list-action-btn {
    opacity: 0.7;
    width: 36px;
    height: 36px;
  }

  .messages-chat-delete {
    opacity: 0.5;
    padding: 6px 8px;
    font-size: 0.78rem;
  }
}

.messages-list-action-btn.delete:hover {
  opacity: 1 !important;
  color: var(--color-accent-red);
  background: rgba(220, 53, 69, 0.12);
}

.messages-list-action-btn.archive:hover,
.messages-list-action-btn.unarchive:hover {
  opacity: 1 !important;
  color: var(--color-gold-2);
  background: var(--color-gold-a12);
}

/* ── Source badge in archive list ── */
.messages-source-badge {
  display: inline-flex;
  align-items: center;
  padding: 1px 6px;
  border-radius: var(--radius-sm);
  font-size: 0.68rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  flex-shrink: 0;
}

.messages-source-badge.inbox {
  background: rgba(74, 105, 160, 0.15);
  color: rgb(120, 160, 220);
}

.messages-source-badge.sent {
  background: var(--color-gold-a12);
  color: var(--color-gold-2);
}

/* ── Batch archive button ── */
.messages-batch-archive-btn {
  display: flex;
  align-items: center;
  gap: 5px;
  padding: 4px 10px;
  border: none;
  border-radius: var(--radius-sm);
  background: var(--color-gold-a12);
  color: var(--color-gold-2);
  font: inherit;
  font-size: 0.78rem;
  font-weight: 600;
  white-space: nowrap;
  cursor: pointer;
  transition: var(--transition-fast);
}

.messages-batch-archive-btn:hover {
  background: var(--color-gold-a18);
}

.messages-conversation-subject {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  min-width: 0;
  font-size: 0.88rem;
}

.messages-conversation-sender-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 8px;
}

.messages-conversation-snippet {
  font-size: 0.8rem;
  color: var(--color-text-muted);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  line-height: 1.3;
}

.messages-meta {
  display: flex;
  gap: 6px;
  flex-shrink: 0;
}

.messages-thread-panel {
  display: flex;
  flex-direction: column;
  overflow: hidden;
  max-height: inherit;
  min-height: 0;
}

.messages-empty {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
}

/* ─── Chat-style timeline ─── */
.messages-chat-timeline {
  flex: 1;
  overflow-y: auto;
  padding: 16px 18px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-height: 0;
}

.messages-chat-row {
  display: flex;
  max-width: 82%;
}

.messages-chat-row.received {
  align-self: flex-start;
}

.messages-chat-row.sent {
  align-self: flex-end;
}

.messages-chat-row.system {
  align-self: flex-start;
  max-width: 90%;
}

.messages-chat-bubble {
  position: relative;
  padding: 10px 14px;
  border-radius: var(--radius-md);
  background: rgba(15, 34, 51, 0.55);
  border: 1px solid var(--color-edge);
}

.messages-chat-row.sent .messages-chat-bubble {
  background: var(--color-gold-a06);
  border-color: var(--color-gold-a18);
}

.messages-chat-row.system .messages-chat-bubble {
  background: rgba(74, 105, 160, 0.08);
  border-color: rgba(74, 105, 160, 0.25);
}

.messages-chat-meta {
  display: flex;
  align-items: baseline;
  gap: 10px;
  margin-bottom: 4px;
}

.messages-chat-sender {
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--color-text-2);
}

.messages-chat-row.sent .messages-chat-sender {
  color: var(--color-gold-2);
}

.messages-chat-row.system .messages-chat-sender {
  color: rgb(120, 160, 220);
}

.messages-chat-time {
  font-size: 0.7rem;
  color: var(--color-text-muted);
  flex-shrink: 0;
}

.messages-chat-content {
  overflow-wrap: break-word;
  line-height: 1.5;
  font-size: 0.88rem;
}

.messages-chat-content .forum-md {
  font-size: 0.88rem;
}

.messages-chat-delete {
  background: none;
  border: none;
  color: var(--color-text-muted);
  cursor: pointer;
  font-size: 0.72rem;
  padding: 2px 4px;
  margin-top: 4px;
  opacity: 0;
  transition: var(--transition-fast);
}

.messages-chat-bubble:hover .messages-chat-delete {
  opacity: 0.5;
}

.messages-chat-delete:hover {
  opacity: 1 !important;
  color: var(--color-accent-red);
}

/* ─── Reply form (expandable) ─── */
.messages-reply-form {
  padding: 16px 18px;
  border-top: 1px solid var(--color-gold-a18);
  flex-shrink: 0;
}

.messages-reply-form .forum-editor-tabs {
  margin-bottom: 0;
}

.messages-reply-form .forum-editor-preview {
  min-height: 100px;
}

.messages-reply-form textarea {
  min-height: 80px;
}

/* ─── Back button: hidden on desktop, shown on mobile ─── */
.messages-back-btn {
  display: none;
  align-items: center;
  gap: 6px;
  padding: 10px 16px;
  border: none;
  border-bottom: 1px solid var(--color-gold-a12);
  background: var(--color-gold-a04);
  color: var(--color-gold-2);
  font: inherit;
  font-size: 0.82rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition-fast);
}

.messages-back-btn:hover {
  background: var(--color-gold-a08);
}

/* ─── Mobile: toggle between list and thread panel ─── */
@media (max-width: 900px) {
  .messages-layout {
    grid-template-columns: 1fr;
    max-height: none;
  }

  .messages-list-panel {
    max-height: calc(100vh - 200px);
  }

  /* Tabs: wrap to a second row when space is tight (sidebar + padding eat width) */
  .messages-view-tabs {
    flex-wrap: wrap;
  }

  .messages-view-tab {
    flex: 0 0 auto;
    padding: 12px 8px;
    font-size: 0.78rem;
    overflow: visible;
    text-overflow: unset;
  }

  /* Thread panel: remove height constraint, let page scroll naturally */
  .messages-thread-panel {
    max-height: none;
    overflow: visible;
    padding-bottom: env(safe-area-inset-bottom, 0px);
  }

  /* Chat timeline: show all messages instead of internal scroll */
  .messages-chat-timeline {
    overflow-y: visible;
  }

  /* When a thread/message is selected: hide list, show thread */
  .messages-layout.thread-active .messages-list-panel {
    display: none;
  }

  /* When no thread is selected: hide thread panel */
  .messages-layout:not(.thread-active) .messages-thread-panel {
    display: none;
  }

  /* Show the back button on mobile */
  .messages-back-btn {
    display: flex;
  }

  /* Reply form: comfortable sizing, page scrolls if needed */
  .messages-reply-form {
    padding: 12px 14px;
  }

  .messages-reply-form textarea {
    min-height: 60px !important;
  }

  .messages-reply-form .forum-editor-preview {
    min-height: 60px;
  }

  /* Conversation items: allow subject row to wrap so timestamp drops below */
  .messages-conversation-subject-row {
    flex-wrap: wrap;
  }

  /* Timestamp moves to its own line when space is tight */
  .messages-conversation-actions {
    gap: 4px;
  }

  /* Ensure action buttons have adequate touch area on mobile */
  .messages-list-action-btn {
    width: 40px;
    height: 40px;
  }

  input.messages-checkbox[type="checkbox"] {
    width: 22px;
    height: 22px;
    min-width: 22px;
    min-height: 22px;
    max-width: 22px;
    max-height: 22px;
  }

  input.messages-checkbox[type="checkbox"]:checked::after {
    left: 7px;
    top: 3px;
    width: 6px;
    height: 11px;
  }

  /* Reduce conversation item padding slightly on mobile */
  .messages-conversation-item {
    padding: 10px 14px;
  }

  /* Ensure chat bubbles use full width on small screens */
  .messages-chat-row {
    max-width: 92%;
  }
}
